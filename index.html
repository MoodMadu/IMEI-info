<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="favicon-brisanet.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard N2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        :root {
            --briz-panel-bg: #1f2937;
            --briz-border: #374151;
            --briz-orange: #f97316;
            --briz-orange-hover: #fb923c;
            --status-andamento: #eab308; /* yellow-500 */
            --status-concluido: #22c55e; /* green-500 */
            --status-fechado: #6b7280;   /* gray-500 */
            --resolution-tn2: #3b82f6;      
            --resolution-tn3: #8b5cf6;      
            --resolution-tba: #db2777;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--briz-panel-bg); }
        ::-webkit-scrollbar-thumb { background: var(--briz-orange); border-radius: 10px; }
        .panel { background-color: var(--briz-panel-bg); border: 1px solid var(--briz-border); border-radius: 8px; }
        #map { height: 100%; width: 100%; border-radius: 8px; z-index: 0; }
        .leaflet-tile-pane { filter: invert(1) hue-rotate(180deg) brightness(0.8) contrast(1); }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: var(--briz-panel-bg); color: #f3f4f6; border: 1px solid var(--briz-orange); }
        #add-ticket-modal { background-color: rgba(0, 0, 0, 0.7); }
    </style>
</head>

<body class="w-full min-h-screen p-4 lg:p-6">

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full max-w-screen-2xl mx-auto">
        
        <aside class="col-span-1 lg:col-span-4 flex flex-col gap-6">
            <div class="panel p-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="https://placehold.co/50x50/f97316/ffffff?text=B" alt="Avatar" class="rounded-full">
                    <div>
                        <h2 class="font-bold text-lg text-white">Equipe de Suporte</h2>
                        <p class="text-sm text-gray-400">Telefonia Móvel</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-white transition-colors" title="Sair"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
            </div>

            <div id="info-panel" class="panel p-4"></div>

            <div class="panel p-4 flex flex-col h-[50vh] lg:h-auto lg:flex-grow">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-xl text-white">Acompanhamento de Chamados</h3>
                    <button id="add-ticket-btn" title="Adicionar Chamado" class="bg-orange-600 hover:bg-orange-500 text-white font-bold w-8 h-8 rounded-full flex items-center justify-center transition-colors">+</button>
                </div>
                <div class="mb-4 grid grid-cols-2 lg:grid-cols-4 gap-2">
                    <button data-filter="all" class="filter-btn flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-2 rounded transition-colors text-sm">Todos</button>
                    <button data-filter="Em Andamento" class="filter-btn flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-2 rounded transition-colors text-sm">Em Andamento</button>
                    <button data-filter="Concluído" class="filter-btn flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-2 rounded transition-colors text-sm">Concluídos</button>
                    <button data-filter="Fechado" class="filter-btn flex-1 bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-2 rounded transition-colors text-sm">Fechados</button>
                </div>
                <div id="tickets-list" class="overflow-y-auto pr-2 space-y-3 flex-grow"></div>
            </div>
        </aside>
        
        <main class="col-span-1 lg:col-span-8 flex flex-col gap-4 h-[85vh]">
            <form id="search-form" class="panel p-2 flex gap-2 relative">
                <input id="search-input" type="text" placeholder="Buscar cidade ou coordenadas..." class="flex-grow bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" autocomplete="off">
                <div id="search-suggestions" class="absolute top-full left-0 right-0 z-10 w-full bg-gray-800 border border-gray-600 rounded mt-1 max-h-48 overflow-y-auto hidden"></div>
                <button type="submit" class="bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 px-4 rounded transition-colors">Buscar</button>
            </form>
            <div class="panel p-1 flex-grow">
                <div id="map"></div>
            </div>
        </main>
    </div>

    <div id="add-ticket-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="panel w-full max-w-2xl">
            <form id="ticket-form" class="p-6">
                <h3 class="font-bold text-xl text-white mb-6">Novo Chamado de Suporte</h3>
                <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-4">
                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input name="id" type="text" placeholder="Nº do Ticket (Ex: 123456)" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" required>
                        <input name="line" type="text" placeholder="Nº da Linha do Cliente" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" required>
                    </div>
                    <!-- Support Type -->
                    <div>
                        <label class="text-sm text-gray-400">Tipo de Suporte</label>
                        <div id="support-type-radios" class="flex gap-4 mt-1">
                            <label class="flex items-center gap-2"><input type="radio" name="supportType" value="FWA" class="form-radio bg-gray-700 text-orange-600" checked> FWA</label>
                            <label class="flex items-center gap-2"><input type="radio" name="supportType" value="Chip Movel" class="form-radio bg-gray-700 text-orange-600"> Chip Móvel</label>
                        </div>
                    </div>
                     <!-- City with Autocomplete -->
                    <div class="relative">
                        <input name="city" id="city-input" type="text" placeholder="Cidade" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" required autocomplete="off">
                        <div id="city-suggestions" class="absolute z-10 w-full bg-gray-800 border border-gray-600 rounded mt-1 max-h-48 overflow-y-auto hidden"></div>
                    </div>
                    <!-- Categories -->
                    <select name="category" id="category-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" required><option value="">Selecione a Categoria Principal</option></select>
                    <select name="subcategory" id="subcategory-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" required><option value="">Selecione a Subcategoria</option></select>
                    
                    <!-- Dynamic Fields: Site/App -->
                    <div id="site-app-details-group" class="hidden space-y-4 p-3 bg-gray-800 rounded-lg">
                        <h4 class="text-sm font-semibold text-gray-300">Detalhes do Site/App</h4>
                        <input name="appName" type="text" placeholder="Nome do App/Site" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                        <input name="appLink" type="text" placeholder="Link (URL)" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                    </div>

                    <!-- Dynamic Fields: Calls -->
                    <div id="call-details-group" class="hidden space-y-4 p-3 bg-gray-800 rounded-lg">
                        <div id="origin-numbers-container">
                            <label class="text-sm font-semibold text-gray-300">Números de Origem (quem ligou para o cliente)</label>
                        </div>
                         <div id="destination-numbers-container" class="mt-4">
                            <label class="text-sm font-semibold text-gray-300">Números de Destino (para quem o cliente ligou)</label>
                        </div>
                    </div>
                    
                    <!-- Status & Resolution -->
                    <select name="status" id="status-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" required>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Concluído">Concluído</option>
                        <option value="Fechado">Fechado</option>
                    </select>

                    <div id="resolution-details-group" class="hidden space-y-4 p-3 bg-gray-800 rounded-lg">
                        <h4 class="text-sm font-semibold text-gray-300">Detalhes da Resolução</h4>
                        <select name="resolutionType" id="resolution-type-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                            <option value="">Selecione o tipo</option>
                            <option value="Tratado TN2">Tratado TN2</option>
                            <option value="Tratado TN3">Tratado TN3</option>
                            <option value="Tratado TBA">Tratado TBA</option>
                        </select>
                        <div id="ba-number-group" class="hidden">
                            <input name="ba" type="text" placeholder="Número do BA" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                        </div>
                        <div id="returned-tn1-group" class="hidden">
                             <label class="flex items-center gap-2 text-sm text-gray-300">
                                <input type="checkbox" name="returnedToTN1" class="form-checkbox bg-gray-700 text-orange-600"> Retornado ao TN1
                            </label>
                        </div>
                    </div>
                    
                    <textarea name="observation" placeholder="Observação: Detalhamento do caso, testes realizados, etc." rows="4" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-ticket-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                    <button type="submit" id="submit-ticket-btn" class="bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 px-4 rounded">Criar Chamado</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    const problemCategories = {
        "Problemas de Ligação": ["Não origina chamada", "Não origina para número específico", "Não origina para 0800/9090", "Restrição de ligação (VIVO, TIM, CLARO)"],
        "Anomalias em Chamadas": ["Chamada cai ao atender", "Falha em chamada a cobrar", "Número aparece como oculto", "Não recebe chamada de alguns números"],
        "Problemas de Mensagens": ["Não envia/recebe SMS", "Problemas com SMS de aplicativos", "Desativar caixa postal"],
        "Rede e Conectividade": ["Reinstalação de eSIM", "Dados móveis não funcionam", "Não acessa site/app específico"]
    };
    const makingCallSubcategories = ["Não origina chamada", "Não origina para número específico", "Não origina para 0800/9090", "Restrição de ligação (VIVO, TIM, CLARO)"];
    const receivingCallSubcategories = ["Não recebe chamada de alguns números"];


    let tickets = [];
    let map;
    let ticketMarkers = {};
    let debounceTimer;

    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        populateCategoryFilter();
        renderAnalytics();
        renderTickets('all');
        setupEventListeners();
        updateFormVisibility(); // Initial call to set form state
    });

    function initMap() {
        map = L.map('map').setView([-5.089, -39.304], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        updateTicketMarkers();
    }
    
    function getStatusColor(status) {
        const colors = { 'Em Andamento': 'var(--status-andamento)', 'Concluído': 'var(--status-concluido)', 'Fechado': 'var(--status-fechado)' };
        return colors[status] || '#888';
    }

    function createTicketIcon(status) {
        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color:${getStatusColor(status)};" class="w-5 h-5 rounded-full border-2 border-white shadow-md"></div>`,
            iconSize: [20, 20], iconAnchor: [10, 10]
        });
    }

    function updateTicketMarkers() {
        Object.values(ticketMarkers).forEach(marker => map.removeLayer(marker));
        ticketMarkers = {};
        tickets.forEach(ticket => {
            const marker = L.marker(ticket.coords, { icon: createTicketIcon(ticket.status) }).addTo(map);
            marker.bindPopup(`<b>Ticket:</b> ${ticket.id}<br><b>Cidade:</b> ${ticket.city}`);
            marker.on('click', () => {
                renderTicketDetails(ticket.id);
                map.flyTo(ticket.coords, 12);
            });
            ticketMarkers[ticket.id] = marker;
        });
    }
    
    const infoPanel = document.getElementById('info-panel');
    const ticketsList = document.getElementById('tickets-list');
    
    function renderAnalytics() {
        const cityCounts = tickets.reduce((acc, t) => { acc[t.city] = (acc[t.city] || 0) + 1; return acc; }, {});
        const sortedCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
        const problemCounts = tickets.reduce((acc, t) => { acc[t.subcategory] = (acc[t.subcategory] || 0) + 1; return acc; }, {});
        const sortedProblems = Object.entries(problemCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
        
        infoPanel.innerHTML = `
            <h3 class="font-bold text-xl mb-3 text-white">Análise de Chamados</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="font-semibold text-gray-300 mb-2">Cidades com mais chamados</h4>
                    <ul class="space-y-1 text-sm">${sortedCities.map(([city, count]) => `<li class="flex justify-between"><span>${city}</span> <span class="font-bold text-orange-400">${count}</span></li>`).join('') || '<li class="text-gray-500 italic">Nenhum chamado registrado.</li>'}</ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-300 mb-2">Problemas mais frequentes</h4>
                    <ul class="space-y-1 text-sm">${sortedProblems.map(([prob, count]) => `<li class="flex justify-between"><span>${prob}</span> <span class="font-bold text-orange-400">${count}</span></li>`).join('') || '<li class="text-gray-500 italic">Nenhum chamado registrado.</li>'}</ul>
                </div>
            </div>`;
    }

    function renderTicketDetails(ticketId) {
        const ticket = tickets.find(t => t.id === ticketId);
        if (!ticket) { renderAnalytics(); return; }

        let detailsHtml = `<div class="flex justify-between items-start">
            <h3 class="font-bold text-xl mb-3 text-white">Detalhes do Ticket</h3>
            <button id="back-to-analytics" class="text-xs text-orange-400 hover:underline">Voltar</button>
        </div>
        <div class="space-y-3 text-sm max-h-[65vh] overflow-y-auto pr-2">
            <div><p class="text-xs text-gray-400">TICKET ID</p><p class="font-semibold text-white">${ticket.id}</p></div>
            <div><p class="text-xs text-gray-400">STATUS</p><p class="font-bold" style="color:${getStatusColor(ticket.status)}">${ticket.status}</p></div>
            <div><p class="text-xs text-gray-400">TIPO SUPORTE</p><p class="font-semibold text-white">${ticket.supportType}</p></div>`;

        if (ticket.status === 'Concluído' && ticket.resolutionType) {
            detailsHtml += `<div><p class="text-xs text-gray-400">RESOLUÇÃO</p><p class="font-semibold text-white">${ticket.resolutionType} ${ticket.returnedToTN1 ? '(Retornado ao TN1)' : ''}</p></div>`;
            if (ticket.ba) {
                detailsHtml += `<div><p class="text-xs text-gray-400">NÚMERO BA</p><p class="font-semibold text-white">${ticket.ba}</p></div>`;
            }
        }

        detailsHtml += `
            <div><p class="text-xs text-gray-400">LINHA</p><p class="font-semibold text-white">${ticket.line}</p></div>
            <div><p class="text-xs text-gray-400">CIDADE</p><p class="font-semibold text-white">${ticket.city}</p></div>
            <div><p class="text-xs text-gray-400">CATEGORIA</p><p class="font-semibold text-white">${ticket.category} > ${ticket.subcategory}</p></div>`;

        if (ticket.appDetails) {
            detailsHtml += `<div><p class="text-xs text-gray-400">DETALHES APP/SITE</p><p class="font-semibold text-white">${ticket.appDetails.name} (<a href="${ticket.appDetails.link}" target="_blank" class="text-orange-400 hover:underline">link</a>)</p></div>`;
        }
        if (ticket.origins && ticket.origins.length > 0) {
            detailsHtml += `<div><p class="text-xs text-gray-400">NÚMEROS DE ORIGEM</p><ul class="list-disc list-inside">${ticket.origins.map(n => `<li class="font-semibold text-white">${n}</li>`).join('')}</ul></div>`;
        }
        if (ticket.destinations && ticket.destinations.length > 0) {
            detailsHtml += `<div><p class="text-xs text-gray-400">NÚMEROS DE DESTINO</p><ul class="list-disc list-inside">${ticket.destinations.map(n => `<li class="font-semibold text-white">${n}</li>`).join('')}</ul></div>`;
        }
        if (ticket.observation) {
            detailsHtml += `<div><p class="text-xs text-gray-400">OBSERVAÇÃO</p><p class="font-semibold text-white whitespace-pre-wrap">${ticket.observation}</p></div>`;
        }
        detailsHtml += `</div>`;
        infoPanel.innerHTML = detailsHtml;
        document.getElementById('back-to-analytics').addEventListener('click', renderAnalytics);
    }
    
    function renderTickets(filter) {
        ticketsList.innerHTML = '';
        const filtered = tickets.filter(t => filter === 'all' || t.status === filter);
        if (filtered.length === 0) {
            ticketsList.innerHTML = '<p class="text-center text-gray-500 italic mt-4">Nenhum chamado encontrado.</p>';
            return;
        }
        filtered.forEach(ticket => {
            const ticketEl = document.createElement('div');
            ticketEl.className = `p-3 bg-gray-800 rounded-lg border-l-4 shadow-md cursor-pointer hover:bg-gray-700`;
            ticketEl.style.borderColor = getStatusColor(ticket.status);
            ticketEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <div><p class="font-bold text-white text-sm">${ticket.subcategory}</p><p class="text-xs text-gray-400">Ticket: ${ticket.id}</p></div>
                    <span class="text-xs font-bold" style="color:${getStatusColor(ticket.status)}">${ticket.status}</span>
                </div>`;
            ticketEl.addEventListener('click', () => renderTicketDetails(ticket.id));
            ticketsList.appendChild(ticketEl);
        });
    }

    async function getCoordsForCity(cityName) {
        if (!cityName) return null;
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&countrycodes=br&format=json&limit=1&addressdetails=1`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            return (data && data.length > 0) ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
        } catch (error) {
            console.error("Failed to fetch coordinates: ", error);
            return null;
        }
    }

    function populateCategoryFilter(isFWA = false) {
        const catSelect = document.getElementById('category-select');
        const callCategories = ["Problemas de Ligação", "Anomalias em Chamadas"];
        
        // Preserve selected value if possible
        const previousValue = catSelect.value;
        catSelect.innerHTML = '<option value="">Selecione a Categoria Principal</option>';

        Object.keys(problemCategories).forEach(cat => {
            // If FWA, skip call-related categories
            if (isFWA && callCategories.includes(cat)) {
                return;
            }
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            catSelect.appendChild(option);
        });
        
        // Restore previous selection if still valid
        if (catSelect.querySelector(`option[value="${previousValue}"]`)) {
            catSelect.value = previousValue;
        } else {
             catSelect.value = '';
        }
    }
    
    function setupEventListeners() {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => renderTickets(btn.dataset.filter)));
        
        const modal = document.getElementById('add-ticket-modal');
        document.getElementById('add-ticket-btn').addEventListener('click', () => {
            updateFormVisibility();
            modal.classList.remove('hidden');
        });
        document.getElementById('cancel-ticket-btn').addEventListener('click', () => {
            modal.classList.add('hidden');
            document.getElementById('ticket-form').reset();
            document.getElementById('city-suggestions').classList.add('hidden');
        });

        const form = document.getElementById('ticket-form');
        form.addEventListener('click', (e) => {
            if (e.target.closest('.add-number-btn')) {
                const type = e.target.closest('.add-number-btn').dataset.type;
                const container = document.getElementById(`${type}-numbers-container`);
                const newInputDiv = document.createElement('div');
                newInputDiv.className = 'flex items-center gap-2 mt-2';
                newInputDiv.innerHTML = `<input type="text" name="${type}" placeholder="Nº de ${type === 'origins' ? 'Origem' : 'Destino'}" class="flex-grow bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"><button type="button" class="remove-number-btn bg-red-600 hover:bg-red-500 text-white w-8 h-8 rounded-full flex-shrink-0">-</button>`;
                container.appendChild(newInputDiv);
            }
            if (e.target.closest('.remove-number-btn')) {
                e.target.closest('.flex').remove();
            }
        });
        
        ['support-type-radios', 'category-select', 'subcategory-select', 'status-select', 'resolution-type-select'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateFormVisibility);
        });


        const cityInput = document.getElementById('city-input');
        cityInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => handleCityAutocomplete(cityInput.value, 'city-suggestions'), 300);
        });
        document.addEventListener('click', (e) => { if (!e.target.closest('.relative')) document.getElementById('city-suggestions').classList.add('hidden'); });
        
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => handleCityAutocomplete(searchInput.value, 'search-suggestions'), 300);
        });
        document.addEventListener('click', (e) => { if (e.target !== searchInput) document.getElementById('search-suggestions').classList.add('hidden'); });

        form.addEventListener('submit', handleAddTicket);
        document.getElementById('search-form').addEventListener('submit', (e) => handleSearch(e, document.getElementById('search-input').value));
        infoPanel.addEventListener('click', e => { if (e.target.id === 'back-to-analytics') renderAnalytics(); });
    }

    function updateFormVisibility() {
        const form = document.getElementById('ticket-form');
        const supportType = form.querySelector('input[name="supportType"]:checked').value;
        const category = form.querySelector('#category-select').value;
        const subcategory = form.querySelector('#subcategory-select').value;
        const status = form.querySelector('#status-select').value;
        const resolutionType = form.querySelector('#resolution-type-select').value;

        const isFWA = supportType === 'FWA';
        const isCallProblem = ["Problemas de Ligação", "Anomalias em Chamadas"].includes(category);
        
        // Update category options based on support type
        populateCategoryFilter(isFWA);

        // Subcategory logic
        const subcatSelect = form.querySelector('#subcategory-select');
        const previousSubcat = subcatSelect.value;
        subcatSelect.innerHTML = '<option value="">Selecione a Subcategoria</option>';
        if (category && problemCategories[category]) {
            problemCategories[category].forEach(sub => {
                const option = document.createElement('option');
                option.value = sub; option.textContent = sub;
                subcatSelect.appendChild(option);
            });
            if(subcatSelect.querySelector(`option[value="${previousSubcat}"]`)) {
                subcatSelect.value = previousSubcat;
            }
        }
        
        // Show/hide groups
        form.querySelector('#call-details-group').classList.toggle('hidden', !isCallProblem || isFWA);
        form.querySelector('#site-app-details-group').classList.toggle('hidden', subcategory !== 'Não acessa site/app específico');
        form.querySelector('#resolution-details-group').classList.toggle('hidden', status !== 'Concluído');

        // Logic within call details
        if(isCallProblem && !isFWA) {
            form.querySelector('#origin-numbers-container').classList.toggle('hidden', makingCallSubcategories.includes(subcategory));
            form.querySelector('#destination-numbers-container').classList.toggle('hidden', receivingCallSubcategories.includes(subcategory));
        }
        
        // Logic within resolution details
        if (status === 'Concluído') {
            const tbaOption = form.querySelector('#resolution-type-select option[value="Tratado TBA"]');
            tbaOption.disabled = !isCallProblem || isFWA;
            if(tbaOption.disabled && resolutionType === 'Tratado TBA') {
                 form.querySelector('#resolution-type-select').value = '';
            }
            form.querySelector('#ba-number-group').classList.toggle('hidden', form.querySelector('#resolution-type-select').value !== 'Tratado TBA');
            form.querySelector('#returned-tn1-group').classList.toggle('hidden', form.querySelector('#resolution-type-select').value !== 'Tratado TN2');
        }
    }


    async function handleCityAutocomplete(query, suggestionsId) {
        const suggestionsContainer = document.getElementById(suggestionsId);
        if (query.length < 3) { suggestionsContainer.classList.add('hidden'); return; }
        
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&countrycodes=br&format=json&limit=5&addressdetails=1`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            suggestionsContainer.innerHTML = '';
            if (data.length > 0) {
                data.forEach(place => {
                    const placeName = place.display_name;
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.className = 'p-2 hover:bg-gray-700 cursor-pointer';
                    suggestionDiv.textContent = placeName;
                    suggestionDiv.addEventListener('click', () => {
                        const inputTargetId = suggestionsId === 'city-suggestions' ? 'city-input' : 'search-input';
                        document.getElementById(inputTargetId).value = placeName;
                        suggestionsContainer.classList.add('hidden');
                        if (inputTargetId === 'search-input') {
                             handleSearch(new Event('submit'), placeName);
                        }
                    });
                    suggestionsContainer.appendChild(suggestionDiv);
                });
                suggestionsContainer.classList.remove('hidden');
            } else { suggestionsContainer.classList.add('hidden'); }
        } catch (error) { console.error("City autocomplete error:", error); }
    }

    async function handleAddTicket(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-ticket-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Buscando Localização...';
        const formData = new FormData(e.target);
        const city = formData.get('city');
        const coords = await getCoordsForCity(city);
        if (!coords) {
            alert('Cidade não encontrada. Selecione uma da lista ou verifique o nome e tente novamente.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Criar Chamado';
            return;
        }
        const getMultiInputValues = (name) => Array.from(document.querySelectorAll(`input[name=${name}]`)).map(input => input.value).filter(Boolean);
        const newTicket = {
            id: formData.get('id'), line: formData.get('line'), city: city, coords: coords,
            supportType: formData.get('supportType'), category: formData.get('category'), subcategory: formData.get('subcategory'),
            status: formData.get('status'),
            resolutionType: formData.get('status') === 'Concluído' ? formData.get('resolutionType') : null,
            returnedToTN1: formData.get('status') === 'Concluído' && formData.get('resolutionType') === 'Tratado TN2' ? formData.get('returnedToTN1') === 'on' : false,
            ba: formData.get('status') === 'Concluído' && formData.get('resolutionType') === 'Tratado TBA' ? formData.get('ba') : null,
            origins: getMultiInputValues('origins'), destinations: getMultiInputValues('destinations'),
            appDetails: formData.get('subcategory') === 'Não acessa site/app específico' ? { name: formData.get('appName'), link: formData.get('appLink') } : null,
            observation: formData.get('observation') || null
        };
        tickets.unshift(newTicket);
        renderTickets('all');
        renderAnalytics();
        updateTicketMarkers();
        e.target.reset();
        document.getElementById('add-ticket-modal').classList.add('hidden');
        ['#resolution-details-group', '#ba-number-group', '#returned-tn1-group', '#call-details-group', '#site-app-details-group'].forEach(sel => document.querySelector(sel).classList.add('hidden'));
        submitBtn.disabled = false;
        submitBtn.textContent = 'Criar Chamado';
    }

    async function handleSearch(e, query) {
        e.preventDefault();
        const coords = await getCoordsForCity(query);
        if (coords) map.flyTo(coords, 12); else alert("Localização não encontrada. Por favor, verifique o nome da cidade.");
    }
    </script>
</body>
</html>
